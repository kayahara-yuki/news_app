# 実装タスク

## 概要

本ドキュメントは、バイラル化クイックウィン機能（音声メッセージ投稿 + ワンタップステータス共有）の実装タスクを定義する。

**フェーズ構成**:
- Phase 1: データベース・ストレージ基盤の準備
- Phase 2: 音声録音・再生機能の実装
- Phase 3: 音声ファイルアップロード機能の実装
- Phase 4: ワンタップステータス共有機能の実装
- Phase 5: 統合・自動削除機能・テスト

**実装順序の根拠**:
1. まずバックエンド基盤を整備（データベーススキーマ、ストレージ）
2. 次にクライアント側の音声録音・再生機能を実装（AVFoundation統合）
3. その後、音声ファイルのアップロード機能を実装
4. ステータス共有機能を実装
5. 最後に全体統合と自動削除機能を実装

---

## Phase 1: データベース・ストレージ基盤の準備

- [ ] 1. Supabaseバックエンドの拡張準備
- [x] 1.1 postsテーブルへのカラム追加とインデックス作成
  - postsテーブルにaudio_url, is_status_post, expires_atカラムを追加
  - 既存データへの影響を確認（既存カラムはNULL許容）
  - expires_atカラムに部分インデックスを作成（パフォーマンス最適化）
  - 既存の投稿取得クエリが正常動作することを確認
  - _Requirements: 1.6, 1.7, 6.1_

- [x] 1.2 Supabase Storageバケットとセキュリティポリシーの設定
  - audioバケットを作成（公開読み取り可能）
  - ユーザーが自分のフォルダにのみアップロード可能なRLSポリシーを設定
  - ユーザーが自分のファイルのみ削除可能なRLSポリシーを設定
  - すべてのユーザーが音声ファイルを読み取り可能なRLSポリシーを設定
  - CORS設定でiOSアプリからのアクセスを許可
  - テストファイルをアップロード・削除して動作確認
  - _Requirements: 1.6, 10.2, 10.3_

- [x] 1.3 Postモデルの拡張とCodingKeys対応
  - PostエンティティにaudioURL, isStatusPost, expiresAtフィールドを追加
  - CodingKeysでSnake CaseとCamel Caseのマッピングを定義
  - 計算プロパティisExpiredとremainingTimeを実装
  - 既存のPost初期化ロジックが正常動作することを確認
  - _Requirements: 1.7, 6.1_

---

## Phase 2: 音声録音・再生機能の実装

- [ ] 2. 音声録音機能の実装
- [x] 2.1 AudioServiceの基本実装と録音機能
  - AVFoundationを使用した音声録音セッションの初期化
  - マイクアクセス許可リクエスト機能の実装
  - AAC形式（.m4a）でのローカル録音機能の実装（44.1kHz, 128kbps）
  - 録音開始・停止メソッドの実装
  - ローカル一時ファイルの保存とURL取得
  - 録音時間の計測とタイマー更新
  - 最大録音時間（30秒）での自動停止機能
  - エラーハンドリング（マイクアクセス拒否、録音失敗）
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 3.1, 3.2, 10.1_

- [x] 2.2 AudioRecorderViewModelの状態管理実装
  - 録音状態（idle, recording, stopped, playing）の管理
  - 録音時間のリアルタイム更新
  - 音声ファイルURLの保持
  - エラーメッセージの管理
  - AudioServiceとの連携
  - 録音開始・停止・再生・削除メソッドの実装
  - @MainActorでUI更新の保証
  - _Requirements: 1.2, 1.3, 2.3, 2.4_

- [x] 2.3 AudioRecorderViewのUI実装
  - マイクボタンと録音開始UIの実装
  - 録音中の視覚的フィードバック（波形アニメーション）の実装
  - 録音経過時間（カウントアップ）表示の実装
  - 残り時間（カウントダウン）表示の実装
  - 停止ボタンの実装
  - キャンセルボタンの実装
  - VoiceOverアクセシビリティラベルの設定
  - Dynamic Type対応
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.7, 12.1, 12.2, 12.4_

- [x] 2.4 音声再生機能の実装
  - AVAudioPlayerを使用した音声再生機能の実装
  - 再生・一時停止メソッドの実装
  - シーク機能（currentTime設定）の実装
  - 再生時間とデュレーションの取得
  - 複数プレイヤーの排他制御（同時再生防止）
  - エラーハンドリング（ファイル読み込み失敗）
  - _Requirements: 3.4, 3.5, 3.6, 3.7_

- [x] 2.5 AudioPlayerViewのUI実装
  - 再生/一時停止ボタンの実装
  - シークバーの実装
  - 再生時間とデュレーション表示の実装
  - 再生進捗のリアルタイム更新
  - VoiceOverアクセシビリティヒントの設定
  - _Requirements: 3.4, 3.5, 3.6, 3.7, 12.6_

---

## Phase 3: 音声ファイルアップロード機能の実装

- [ ] 3. 音声ファイルのアップロードと投稿機能の統合
- [x] 3.1 StorageRepositoryの実装
  - Supabase Storage SDKとの統合
  - ファイルアップロードメソッドの実装（bucket, path, data）
  - ファイル削除メソッドの実装
  - Public URL取得メソッドの実装
  - HTTPSでの暗号化転送を確認
  - エラーハンドリング（ネットワークエラー、容量制限）
  - _Requirements: 1.6, 3.3, 10.2_

- [x] 3.2 AudioServiceへのアップロード機能追加
  - ローカル音声ファイルのDataへの変換
  - StorageRepositoryを使用したアップロード処理
  - ファイルパス生成ロジック（audio/{user_id}/{timestamp}.m4a）
  - アップロード成功時のURL取得
  - アップロード進捗の追跡とPublish
  - アップロード失敗時のリトライロジック（Exponential Backoff）
  - タイムアウト処理（30秒）
  - _Requirements: 1.6, 1.7, 1.9, 9.2, 9.5_

- [x] 3.3 PostServiceへの音声投稿機能追加
  - 音声ファイル付き投稿作成メソッドの実装
  - AudioServiceのアップロード処理との連携
  - アップロード成功後の投稿データ作成
  - 位置情報の自動付与
  - 投稿成功時のローカルファイル削除
  - エラーハンドリング（アップロード失敗時のローカルファイル保持）
  - _Requirements: 1.6, 1.7, 1.8, 1.9, 2.8, 10.3_

- [x] 3.4 PostCreationViewへの音声録音UI統合
  - テキストフィールド下部にマイクボタンを配置
  - AudioRecorderViewの統合
  - 録音完了後の音声プレイヤー表示
  - 音声ファイル添付状態の管理
  - 投稿ボタンタップ時の音声ファイル送信
  - ローディングインジケーターの表示
  - トーストメッセージ表示（投稿成功時）
  - _Requirements: 2.1, 2.2, 2.5, 2.6, 2.8, 9.1, 9.4_

- [x] 3.5 投稿詳細画面での音声再生機能の追加
  - PostDetailViewにAudioPlayerViewを統合
  - 音声URL存在時のみプレイヤーを表示
  - Supabase Storageからの音声ファイルストリーミング再生
  - 読み込み失敗時のエラー表示
  - _Requirements: 3.4, 3.5, 3.8_

---

## Phase 4: ワンタップステータス共有機能の実装

- [ ] 4. ステータス投稿機能の実装
- [x] 4.1 StatusTypeの定義とプリセットステータスの管理
  - StatusType列挙型の定義（8種類のステータス）
  - 各ステータスの絵文字とテキストマッピング
  - 地図表示用の絵文字アイコン取得機能
  - _Requirements: 4.2, 7.2_

- [x] 4.2 StatusButtonsViewの実装
  - 横スクロール可能なステータスボタン一覧の実装
  - 8種類のプリセットステータスボタンの表示
  - ボタンタップ時のハイライト表示
  - 単一選択ロジック（最後に選択されたもののみアクティブ）
  - @Binding経由での親Viewへの選択通知
  - VoiceOverアクセシビリティラベルの設定
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 12.3_

- [x] 4.3 PostServiceへのステータス投稿機能追加
  - ステータス投稿作成メソッドの実装
  - isStatusPostフラグの設定
  - expiresAtの計算（投稿時刻 + 3時間）
  - 位置情報の自動付与
  - 投稿内容にステータステキストを設定
  - 投稿成功時のレスポンス処理
  - _Requirements: 5.1, 5.2, 6.1_

- [x] 4.4 PostCreationViewへのステータスボタン統合
  - 投稿作成画面上部にStatusButtonsViewを配置
  - ステータス選択時のテキストフィールド自動入力
  - ステータスボタンタップ時のワンタップ投稿実行
  - 位置情報未取得時のエラー表示
  - 投稿送信中のローディング表示
  - 投稿成功時のトーストメッセージ（0.5秒間表示）
  - 投稿成功時の画面自動クローズ
  - _Requirements: 4.5, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 9.3, 9.4_

- [x] 4.5 地図画面でのステータス投稿表示
  - ステータス投稿用の専用ピン表示（絵文字アイコン）
  - ステータスごとのアイコンマッピング（カフェなう→☕）
  - ピンタップ時の簡易カード表示（ユーザー名 + ステータス + 残り時間）
  - 残り時間が1時間未満の場合のピン透明度変更（50%）
  - 削除された投稿のピン即座削除
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 4.6 投稿カードでの残り時間表示
  - ステータス投稿の残り時間計算ロジック
  - 投稿カードに残り時間表示（「あと2時間で削除」）
  - 削除予定時刻の1時間前に「まもなく削除されます」バッジ表示
  - リアルタイム更新（1分ごと）
  - _Requirements: 6.3, 6.4_

---

## Phase 5: 統合・自動削除機能・テスト

- [ ] 5. 音声投稿とステータス投稿の統合機能
- [x] 5.1 音声ファイルとステータスの組み合わせ投稿
  - ステータス選択後の音声録音を許可
  - 音声録音後のステータス選択を許可
  - 両方が設定された場合の投稿データ作成
  - content（ステータステキスト） + audio_url の両方を含む投稿送信
  - 投稿カードでステータステキストと音声プレイヤーの両方表示
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [x] 5.2 通常投稿とステータス投稿の判定ロジック
  - ステータス選択のみ→ステータス投稿（自動削除あり）
  - テキスト編集でステータス以外の内容追加→通常投稿（自動削除なし）
  - 投稿作成時のisStatusPost判定ロジック
  - _Requirements: 8.5_

- [ ] 6. ステータス投稿の自動削除機能
- [x] 6.1 Supabase Edge Functionの実装
  - expires_at < NOW()の投稿を検索するクエリ
  - 各投稿の音声ファイルを削除（Supabase Storage）
  - 関連データ（いいね、コメント）を削除
  - 投稿レコードを削除
  - エラーハンドリングとログ出力
  - _Requirements: 6.2, 6.6, 10.6_

- [x] 6.2 Edge Functionのデプロイと定期実行設定
  - Supabase Edge Functionのデプロイ
  - Cronトリガー設定（毎時00分実行）
  - 動作確認（テストデータで3時間経過投稿の削除）
  - 誤削除が発生しないことの確認
  - _Requirements: 6.2_

- [x] 6.3 手動削除機能の実装
  - ステータス投稿の手動削除時に自動削除スケジュールをキャンセル
  - 音声ファイルの即座削除
  - 関連データの即座削除
  - _Requirements: 6.5_

- [ ] 7. エラーハンドリングとフォールバック
- [x] 7.1 パーミッション関連エラーの処理
  - マイクアクセス拒否時のアラート表示と設定画面リンク
  - 位置情報アクセス拒否時のステータスボタン非アクティブ化
  - AVFoundation利用不可時の音声録音ボタン非表示
  - _Requirements: 10.1, 10.5, 11.1, 11.2_

- [x] 7.2 ネットワークエラーとリトライ処理
  - 音声アップロード失敗時のローカルファイル保持とリトライオプション
  - 投稿送信失敗時の下書き保存と「後で送信」オプション
  - ネットワークタイムアウト時の自動リトライ（Exponential Backoff）
  - ファイルサイズ超過時の警告表示
  - _Requirements: 1.9, 5.6, 9.6, 11.4, 11.5_

- [x] 7.3 アプリライフサイクルエラーの処理
  - 録音中にバックグラウンド移行時の一時停止処理
  - フォアグラウンド復帰時の再開オプション表示
  - _Requirements: 11.3_

- [x] 7.4 ストレージ容量制限エラーの処理
  - Supabase Storage容量制限エラーの検出
  - エラーメッセージ表示「ストレージ容量が不足しています。古い投稿を削除してください」
  - _Requirements: 11.6_

- [ ] 8. パフォーマンス最適化とテスト
- [x] 8.1 パフォーマンス測定と最適化
  - 音声録音開始時間を0.5秒以内に最適化
  - ステータス投稿送信時間を0.3秒以内に最適化
  - UIアニメーションフレームレート60fps維持の確認
  - 音声ファイルアップロード速度の測定（1MB/秒以上）
  - _Requirements: 9.1, 9.3_

- [x] 8.2 ユニットテストの実装
  - AudioRecorderViewModelの状態遷移テスト
  - AudioServiceの録音・再生・アップロード機能テスト
  - PostServiceのステータス投稿・音声投稿機能テスト
  - StorageRepositoryのアップロード・削除機能テスト
  - _Requirements: すべての機能要件_

- [x] 8.3 統合テストの実装
  - 音声録音→アップロード→投稿作成フローの統合テスト
  - ステータス投稿→自動削除フローの統合テスト
  - 音声再生フローの統合テスト
  - 実際のSupabase環境でのE2Eテスト
  - _Requirements: すべての機能要件_

- [x] 9. アクセシビリティ対応
- [x] 9.1 VoiceOverサポートの実装
  - 音声録音ボタンのアクセシビリティラベル設定
  - ステータスボタンのアクセシビリティラベル設定
  - 音声プレイヤーのアクセシビリティヒント設定
  - 録音進行状況の音声通知
  - _Requirements: 12.1, 12.2, 12.3, 12.5, 12.6_

- [x] 9.2 Dynamic Type対応
  - 音声録音UIのフォントサイズ自動調整（AudioRecorderView.swift）
  - ステータスボタンのテキストサイズ自動調整（StatusButtonsView.swift - 既存実装）
  - @Environment(\.sizeCategory)を使用した動的フォントサイズ調整
  - アクセシビリティカテゴリでのレイアウト調整
  - _Requirements: 12.4_

---

## 要件カバレッジマトリクス

| 要件ID | タスク番号 | 要件概要 |
|-------|----------|---------|
| 1.1-1.9 | 2.1, 3.2, 3.3, 3.4, 7.2 | 音声メッセージの録音とアップロード |
| 2.1-2.8 | 2.3, 3.4 | 音声録音UIの統合 |
| 3.1-3.8 | 2.1, 2.4, 2.5, 3.5 | 音声ファイルの録音品質と再生 |
| 4.1-4.5 | 4.1, 4.2, 4.4 | プリセットステータスボタンの表示 |
| 5.1-5.7 | 4.3, 4.4, 7.2 | ワンタップ投稿の実行 |
| 6.1-6.6 | 1.1, 4.6, 6.1, 6.2, 6.3 | ステータス投稿の自動削除 |
| 7.1-7.5 | 4.5, 4.6 | 地図上のステータス投稿表示 |
| 8.1-8.5 | 5.1, 5.2 | 音声投稿とステータス投稿の統合 |
| 9.1-9.6 | 8.1 | パフォーマンスと応答性 |
| 10.1-10.6 | 1.2, 3.1, 7.1 | プライバシーとセキュリティ |
| 11.1-11.6 | 7.1, 7.2, 7.3, 7.4 | エラーハンドリングとフォールバック |
| 12.1-12.6 | 9.1, 9.2 | アクセシビリティ対応 |

---

## 実装順序の推奨

1. **Phase 1を完全に完了**してからPhase 2に進む（データベース基盤が必須）
2. **Phase 2とPhase 3は順次実行**（録音機能が完成してからアップロード機能を実装）
3. **Phase 4は独立して実装可能**（ステータス投稿は音声投稿と並行開発可能）
4. **Phase 5は最後**（すべての機能が揃ってから統合とテスト）

---

## 完了基準

すべてのタスクが完了し、以下の検証をクリアした時点で実装完了とする:

- [ ] すべての要件（Requirement 1-12）が実装されている
- [ ] ユニットテスト・統合テストがすべてパス
- [ ] パフォーマンス目標（音声録音開始0.5秒、ステータス投稿0.3秒、60fps）を達成
- [ ] アクセシビリティテスト（VoiceOver、Dynamic Type）がパス
- [ ] 既存機能に影響がないことを確認
- [ ] マイグレーションが成功し、ロールバック手順が確立されている
