# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  # Configuration
  SCHEME = "LocationNewsSNS"
  PROJECT = "LocationNewsSNS.xcodeproj"
  BUNDLE_ID = "com.locationnewssns.app"
  
  # Before all lanes
  before_all do
    setup_circle_ci if ENV['CI']
  end

  desc "Build and run tests"
  lane :test do
    run_tests(
      project: PROJECT,
      scheme: SCHEME,
      device: "iPhone 15",
      clean: true,
      code_coverage: true
    )
  end

  desc "Build the app for development"
  lane :build_dev do
    match(type: "development", readonly: true)
    
    build_app(
      project: PROJECT,
      scheme: SCHEME,
      configuration: "Debug",
      clean: true,
      output_directory: "./builds",
      output_name: "LocationNewsSNS-dev.ipa",
      export_method: "development"
    )
  end

  desc "Build the app for App Store"
  lane :build_release do
    match(type: "appstore", readonly: true)
    
    increment_build_number(
      xcodeproj: PROJECT
    )
    
    build_app(
      project: PROJECT,
      scheme: SCHEME,
      configuration: "Release",
      clean: true,
      output_directory: "./builds",
      output_name: "LocationNewsSNS.ipa",
      export_method: "app-store"
    )
  end

  desc "Deploy to TestFlight"
  lane :deploy_testflight do
    build_release
    
    upload_to_testflight(
      api_key_path: "fastlane/AuthKey.p8",
      skip_waiting_for_build_processing: true,
      changelog: "ãƒã‚°ä¿®æ­£ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„"
    )
    
    # Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    slack(
      message: "ğŸš€ LocationNewsSNS ã®æ–°ã—ã„ãƒ“ãƒ«ãƒ‰ãŒTestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸï¼",
      channel: "#ios-releases",
      default_payloads: [:git_branch, :git_author, :last_git_commit_message]
    ) if ENV['SLACK_URL']
  end

  desc "Deploy to App Store"
  lane :deploy_appstore do
    build_release
    
    upload_to_app_store(
      api_key_path: "fastlane/AuthKey.p8",
      force: true,
      submit_for_review: false,
      metadata_path: "./fastlane/metadata",
      screenshots_path: "./fastlane/screenshots"
    )
    
    # Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    slack(
      message: "ğŸ‰ LocationNewsSNS ãŒApp Storeã«æå‡ºã•ã‚Œã¾ã—ãŸï¼",
      channel: "#ios-releases"
    ) if ENV['SLACK_URL']
  end

  desc "Take screenshots for App Store"
  lane :screenshots do
    capture_screenshots(
      scheme: SCHEME,
      devices: [
        "iPhone 15 Pro Max",
        "iPhone 15",
        "iPhone SE (3rd generation)",
        "iPad Pro (12.9-inch) (6th generation)"
      ],
      languages: ["ja-JP", "en-US"],
      clear_previous_screenshots: true,
      override_status_bar: true,
      localize_simulator: true
    )
    
    frame_screenshots(
      white: true,
      path: "./fastlane/screenshots"
    )
  end

  desc "Update certificates and provisioning profiles"
  lane :update_certificates do
    match(type: "development", force_for_new_devices: true)
    match(type: "appstore")
  end

  desc "Run SwiftLint"
  lane :lint do
    swiftlint(
      mode: :lint,
      config_file: ".swiftlint.yml",
      strict: true
    )
  end

  desc "Setup project for CI"
  lane :setup_ci do
    setup_circle_ci
    match(type: "development", readonly: true)
    match(type: "appstore", readonly: true)
  end

  # Error handling
  error do |lane, exception, options|
    if ENV['SLACK_URL']
      slack(
        message: "âŒ Fastlane ã‚¨ãƒ©ãƒ¼: #{exception.message}",
        channel: "#ios-releases",
        success: false
      )
    end
  end
end